<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Généalogie Timeline 2D</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white; margin: 20px; }
        #canvas { background: #222; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); overflow-x: auto; }
        .person-bar { cursor: pointer; stroke: rgba(255,255,255,0.2); stroke-width: 1; }
        .person-bar:hover { filter: brightness(1.2); stroke: #fff; }
        .label { font-size: 11px; fill: white; pointer-events: none; font-weight: bold; }
        .tick text { fill: #888; font-size: 12px; }
        .domain { stroke: #444; }
        #tooltip {
            position: absolute; visibility: hidden;
            background: rgba(40, 40, 40, 0.95); color: white;
            border: 1px solid #555; padding: 12px; border-radius: 6px;
            font-size: 13px; pointer-events: none; z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        h2 { color: #4a90e2; }
    </style>
</head>
<body>
    <h2>Visualisation Temporelle</h2>
    <div id="canvas"></div>
    <div id="tooltip"></div>

<script>
// 1. Données enrichies
const data = [
    { id: "ID001", sex: "M" , name: "Louis XIV", birth: 1638, death: 1715, parents: ["ID007"], info: "Le Roi Soleil" },
    { id: "ID002", sex: "M" , name: "Louis le Grand Dauphin", birth: 1661, death: 1711, parents: ["ID001", "ID005"], info: "Fils de Louis XIV" },
    { id: "ID003", sex: "M" , name: "Louis de France", birth: 1682, death: 1712, parents: ["ID002"], info: "Petit-fils de Louis XIV" },
    { id: "ID004", sex: "M" , name: "Louis XV", birth: 1710, death: 1774, parents: ["ID003"], info: "Arrière-petit-fils de Louis XIV" },
    { id: "ID005", sex: "F" , name: "Marie-Thérèse d'Autriche", birth: 1638, death: 1683, info: "Épouse de Louis XIV" },
    { id: "ID006", sex: "M" , name: "Philippe d'Orléans", birth: 1640, death: 1701, parents: ["ID007"], info: "Frère du Roi" },
    { id: "ID007", sex: "M" , name: "Ancêtre lointain", birth: 1610, death: 1660, info: "Génération précédente" }
];

// 2. Fonction de couleur
const getGenderColor = (sex) => sex === "M" ? "#4a90e2" : sex === "F" ? "#e24a90" : "#999";

const margin = {top: 40, right: 50, bottom: 60, left: 20};
const width = 900 - margin.left - margin.right;
const barHeight = 25;
const barPadding = 8;


// Algorithme de placement (Tracks)
data.sort((a, b) => a.birth - b.birth);
let tracks = [];
data.forEach(p => {
    let trackIndex = tracks.findIndex(tEnd => tEnd < p.birth);
    if (trackIndex === -1) {
        trackIndex = tracks.length;
        tracks.push(p.death);
    } else {
        tracks[trackIndex] = p.death;
    }
    p.track = trackIndex;
});
    
const height = (tracks.length * (barHeight + barPadding)) + margin.top + margin.bottom;


const svg = d3.select("#canvas").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

const x = d3.scaleLinear()
    .domain([d3.min(data, d => d.birth) - 10, d3.max(data, d => d.death) + 10])
    .range([0, width]);

// 3. Dessiner les liens (à faire AVANT les barres pour qu'ils soient derrière)
const links = data.filter(d => d.parents);
svg.selectAll(".link")
    .data(links)
    .enter().append("path")
    .attr("d", d => {
        const child = d;
        const parent = data.find(p => p.id === d.parents[0]); // Lien vers le premier parent pour l'exemple
        if (!parent) return "";
        
        // Création d'un chemin en "L" (vertical puis horizontal)
        const xStart = x(parent.death); // Part de la fin de vie du parent
        const yStart = parent.track * (barHeight + barPadding) + barHeight / 2;
        const xEnd = x(child.birth);   // Arrive au début de vie de l'enfant
        const yEnd = child.track * (barHeight + barPadding) + barHeight / 2;
        
        return `M${xStart},${yStart} L${xStart + 10},${yStart} L${xStart + 10},${yEnd} L${xEnd},${yEnd}`;
    })
    .attr("fill", "none")
    .attr("stroke", "#555")
    .attr("stroke-width", 1.5);

    // Axe X
    svg.append("g")
        .attr("transform", `translate(0, ${height - margin.bottom})`)
        .call(d3.axisBottom(x).tickFormat(d3.format("d")).tickSize(-height + margin.top + margin.bottom));

    const bars = svg.selectAll(".person-group")
        .data(data)
        .enter().append("g")
        .attr("class", "person-group");

    bars.append("rect")
        .attr("class", "person-bar")
        .attr("x", d => x(d.birth))
        .attr("y", d => d.track * (barHeight + barPadding))
        .attr("width", d => Math.max(x(d.death) - x(d.birth), 2))
        .attr("height", barHeight)
        .attr("fill", d => getGenderColor(d.sex))
        .attr("rx", 5)
        .on("mouseover", (event, d) => {
            d3.select("#tooltip")
                .style("visibility", "visible")
                .html(`<strong>${d.name}</strong><br>${d.birth} — ${d.death}<br><hr style='border:0;border-top:1px solid #444'>${d.info}`);
        })
        .on("mousemove", (event) => {
            d3.select("#tooltip")
                .style("top", (event.pageY - 10) + "px")
                .style("left", (event.pageX + 20) + "px");
        })
        .on("mouseout", () => d3.select("#tooltip").style("visibility", "hidden"));

    bars.append("text")
        .attr("class", "label")
        .attr("x", d => x(d.birth) + 10)
        .attr("y", d => d.track * (barHeight + barPadding) + (barHeight / 1.5))
        .text(d => d.name)
        .style("opacity", d => (x(d.death) - x(d.birth) > 60) ? 1 : 0); // Cache le texte si la barre est trop courte

</script>
</body>
</html>